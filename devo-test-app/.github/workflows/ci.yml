name: TestDevoApp CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-scenario: [normal, warning, failure]
    
    steps:
    - name: ðŸ” Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'devo-test-app/package.json'
    
    - name: ðŸ“¦ Install Dependencies
      working-directory: ./devo-test-app
      run: |
        npm ci
        echo "Dependencies installed successfully"
    
    - name: ðŸ§ª Run Tests (Normal Scenario)
      if: matrix.test-scenario == 'normal'
      working-directory: ./devo-test-app
      run: |
        echo "âœ… Running normal test scenario"
        npm test
        echo "All tests passed successfully"
    
    - name: âš ï¸ Run Tests (Warning Scenario)
      if: matrix.test-scenario == 'warning'
      working-directory: ./devo-test-app
      run: |
        echo "âš ï¸  Running warning test scenario"
        # This will show warnings but not fail
        npm test
        echo "WARNING: This scenario demonstrates warning logs for Devo collection"
      continue-on-error: false
    
    - name: âŒ Run Tests (Failure Scenario)
      if: matrix.test-scenario == 'failure'
      working-directory: ./devo-test-app
      env:
        TRIGGER_FAIL: true
      run: |
        echo "âŒ Running failure test scenario"
        echo "This test is designed to fail for Devo log collection testing"
        npm test || echo "Expected failure occurred"
      continue-on-error: true
    
    - name: ðŸ—ï¸ Build Application
      if: matrix.test-scenario != 'failure'
      working-directory: ./devo-test-app
      run: |
        echo "ðŸ—ï¸  Building Next.js application"
        npm run build
        echo "Build completed successfully"
    
    - name: ðŸ” Lint Code
      working-directory: ./devo-test-app
      run: |
        echo "ðŸ” Running ESLint"
        npm run lint || echo "Linting completed with warnings"
    
    - name: ðŸ“Š Generate Test Report
      if: always()
      working-directory: ./devo-test-app
      run: |
        echo "ðŸ“Š Test Scenario: ${{ matrix.test-scenario }}"
        echo "ðŸš€ Workflow Run ID: ${{ github.run_id }}"
        echo "ðŸ“‹ Repository: ${{ github.repository }}"
        echo "ðŸŒŸ Commit SHA: ${{ github.sha }}"
        echo "ðŸ‘¤ Actor: ${{ github.actor }}"
        
        # Create log file for Devo collection
        mkdir -p logs
        cat > logs/test-report-${{ matrix.test-scenario }}.json << EOF
        {
          "scenario": "${{ matrix.test-scenario }}",
          "run_id": "${{ github.run_id }}",
          "repository": "${{ github.repository }}",
          "commit_sha": "${{ github.sha }}",
          "actor": "${{ github.actor }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "status": "${{ job.status }}"
        }
        EOF
    
    - name: â¬†ï¸ Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-${{ matrix.test-scenario }}
        path: devo-test-app/logs/
        retention-days: 30

  # Dedicated job for intentional failures
  trigger-devo-collection:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[trigger-fail]') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ðŸ” Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'devo-test-app/package.json'
    
    - name: ðŸ“¦ Install Dependencies
      working-directory: ./devo-test-app
      run: npm ci
    
    - name: âŒ Intentional Failure for Devo
      working-directory: ./devo-test-app
      env:
        INTENTIONAL_FAIL: true
        TRIGGER_FAIL: true
      run: |
        echo "âŒ INTENTIONAL FAILURE JOB"
        echo "This job is designed to fail for Devo log collection testing"
        echo "Run ID: ${{ github.run_id }}"
        echo "Repository: ${{ github.repository }}"
        
        # Run tests that will intentionally fail
        npm test
        
        # This should not be reached due to test failure
        echo "âŒ ERROR: Tests should have failed but didn't"
        exit 1
    
    - name: ðŸš¨ Failure Notification
      if: failure()
      run: |
        echo "ðŸš¨ EXPECTED FAILURE OCCURRED"
        echo "ðŸ”— This failure can be collected by Devo using:"
        echo "ðŸ“Š Run ID: ${{ github.run_id }}"
        echo "ðŸ“‹ Repository: ${{ github.repository }}"
        echo "ðŸ“ Use the ci_cd_collector.py to fetch these logs"

  # Summary job
  summary:
    runs-on: ubuntu-latest
    needs: [test-and-build]
    if: always()
    
    steps:
    - name: ðŸ“‹ Workflow Summary
      run: |
        echo "ðŸ“‹ TestDevoApp CI/CD Pipeline Summary"
        echo "ðŸƒ Jobs completed: ${{ needs.test-and-build.result }}"
        echo "ðŸ”— This workflow provides logs for Devo collection"
        echo "ðŸ“Š Use GitHub API to fetch logs with run ID: ${{ github.run_id }}"
        echo ""
        echo "ðŸ”§ To trigger intentional failures, include '[trigger-fail]' in commit message"
        echo "ðŸ“ Devo Collector Usage:"
        echo "   Repository: ${{ github.repository }}"
        echo "   Run ID: ${{ github.run_id }}"
